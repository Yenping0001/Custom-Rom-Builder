name: Build Project Infinity X ROM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 🧼 Clean workspace
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🕰️ Set up build environment
      run: |
        sudo rm -rf /etc/apt/sources.list.d/*
        sudo apt-mark hold grub-efi-amd64-signed
        sudo apt-get update
        sudo apt-get install -y git curl python3 unzip bc

    - name: 📦 Clone repo binary manually
      run: |
        mkdir -p ~/bin
        curl -o ~/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        chmod a+x ~/bin/repo
        echo 'export PATH=~/bin:$PATH' >> $GITHUB_ENV

    - name: 📁 Initialize repo
      run: |
        mkdir rom && cd rom
        repo init -u https://github.com/ProjectInfinity-X/manifest.git -b 16
        repo sync -c --no-tags --no-clone-bundle --optimized-fetch --prune

    - name: 📥 Clone device, vendor, kernel trees
      run: |
        cd rom
        git clone -b twrp https://github.com/Yenping0001/android_device_samsung_a32x.git device/samsung/a32x
        git clone -b master https://github.com/Yenping0001/vendor_samsung_a32x.git vendor/samsung
        git clone https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel/samsung/a32x

    - name: ⚙️ Start build
      run: |
        cd rom
        source build/envsetup.sh
        lunch infinity_a32x-userdebug
        make -j$(nproc) otapackage

    - name: 📤 Upload ROM zip
      uses: actions/upload-artifact@v4
      with:
        name: InfinityX-ROM
        path: rom/out/target/product/*/*.zip
